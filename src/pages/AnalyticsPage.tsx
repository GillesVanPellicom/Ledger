import React, {useState, useEffect, useMemo, useRef, useCallback, useLayoutEffect} from 'react';import ReactECharts from 'echarts-for-react';import Select from '../components/ui/Select';import Card from '../components/ui/Card';import {  ArrowDownIcon,  ArrowUpIcon,  CalculatorIcon,  ShoppingBagIcon,  CurrencyEuroIcon,  InformationCircleIcon,  MinusIcon} from '@heroicons/react/24/solid';import Spinner from '../components/ui/Spinner';import TopProducts from '../components/analytics/TopProducts';import {cn} from '../utils/cn';import Tooltip from '../components/ui/Tooltip';import InfoCard from '../components/ui/InfoCard';import {useNavigate} from 'react-router-dom';import { Header } from '../components/ui/Header';import PageWrapper from '../components/layout/PageWrapper';import { useAvailableYears, useAnalyticsData } from '../hooks/useAnalytics';import { useSettingsStore } from '../store/useSettingsStore';const AnalyticsPage: React.FC = () => {  const monthlyChartRef = useRef<ReactECharts>(null);  const storeChartRef = useRef<ReactECharts>(null);  const debtBarChartRef = useRef<ReactECharts>(null);  const navigate = useNavigate();  const [activeTab, setActiveTab] = useState('general');  const [selectedYear, setSelectedYear] = useState<string>(new Date().getFullYear().toString());  const {settings} = useSettingsStore();  const paymentMethodsEnabled = settings.modules.paymentMethods?.enabled;  const debtEnabled = settings.modules.debt?.enabled;  const isDarkMode = useMemo(() => document.documentElement.classList.contains('dark'), []);  const theme = isDarkMode ? 'dark' : 'light';  const { data: availableYears } = useAvailableYears();  const { data: analyticsData, isLoading } = useAnalyticsData(selectedYear, paymentMethodsEnabled, debtEnabled);  useEffect(() => {    if (availableYears && availableYears.length > 0 && !availableYears.includes(selectedYear)) {      setSelectedYear(availableYears[0]);    }  }, [availableYears, selectedYear]);  const monthlyChartOption = useMemo(() => ({    backgroundColor: 'transparent',    tooltip: {      trigger: 'axis',      valueFormatter: (value: number | string) => typeof value === 'number' ? `€${value.toFixed(2)}` : value    },    xAxis: {      type: 'category',      data: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']    },    yAxis: {type: 'value', axisLabel: {formatter: '€{value}'}},    series: [{data: analyticsData?.monthlySpending.map(m => m.total.toFixed(2)) || [], type: 'bar'}],    grid: {left: '3%', right: '4%', bottom: '3%', containLabel: true}  }), [analyticsData?.monthlySpending]);  const storeChartOption = useMemo(() => ({    backgroundColor: 'transparent',    tooltip: {trigger: 'item', formatter: '{b}: €{c} ({d}%)'},    legend: {orient: 'vertical', left: 'left', type: 'scroll'},    series: [{      name: 'Store Spending',      type: 'pie',      radius: '50%',      data: analyticsData?.storeSpending || [],      emphasis: {itemStyle: {shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)'}}    }]  }), [analyticsData?.storeSpending]);  const debtBarChartOption = useMemo(() => ({    backgroundColor: 'transparent',    tooltip: {      trigger: 'axis',      axisPointer: {type: 'shadow'},      formatter: (params: any) => `${params[0].name}: €${params[0].value.toFixed(2)}`    },    grid: {left: '3%', right: '4%', bottom: '3%', containLabel: true},    xAxis: {type: 'category', data: analyticsData?.debtStats.netBalances.map(d => d.name) || []},    yAxis: {type: 'value', axisLabel: {formatter: '€{value}'}},    series: [{      name: 'Net Balance',      type: 'bar',      label: {show: true, position: 'top', formatter: (params: any) => `€${params.value.toFixed(2)}`},      data: analyticsData?.debtStats.netBalances.map(d => ({        value: d.value,        itemStyle: {color: d.value >= 0 ? '#91cc75' : '#ee6666'}      })) || [],    }]  }), [analyticsData?.debtStats.netBalances]);  const TrendIndicator = ({current, previous}: { current: number, previous: number }) => {    if (previous === 0 || current === 0) return <span className="text-gray-300 dark:text-gray-600">-</span>;    const change = ((current - previous) / previous) * 100;    const diff = current - previous;    const isUp = change > 0;    const colorClass = isUp ? 'text-red' : 'text-green';    return (<div className="flex flex-col items-center">      <span className={`flex items-center text-xs font-medium ${colorClass}`}>{isUp ?        <ArrowUpIcon className="h-3 w-3 mr-0.5"/> :        <ArrowDownIcon className="h-3 w-3 mr-0.5"/>}{Math.abs(change).toFixed(0)}%</span><span className={`text-[10px] ${colorClass}`}>{diff > 0 ? '+' : ''}€{diff.toFixed(0)}</span>    </div>);  };  const CardHeader = ({title, tooltipText}: { title: string, tooltipText: string }) => (    <div className="flex items-center gap-2 mb-4">      <h3 className="text-lg font-semibold">{title}</h3>      <Tooltip content={tooltipText}><InformationCircleIcon className="h-5 w-5 text-gray-400"/></Tooltip>    </div>  );  const renderTabs = () => {    const tabs = [      { id: 'general', label: 'General' },      { id: 'products', label: 'Products' },      ...(debtEnabled ? [{ id: 'debt', label: 'Debt' }] : []),    ];    return (      <nav className="flex space-x-8" aria-label="Tabs">        {tabs.map((tab) => (          <button            key={tab.id}            onClick={() => setActiveTab(tab.id)}            className={cn(              tab.id === activeTab                ? 'border-accent text-accent'                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600',              'whitespace-nowrap px-1 border-b-2 font-medium text-sm'            )}          >            {tab.label}          </button>        ))}      </nav>    );  };  const gridContainerRef = useRef<HTMLDivElement>(null);  const [itemsToRender, setItemsToRender] = useState(9);  const calculateGridItems = useCallback(() => {    if (!gridContainerRef.current) return;    const containerHeight = gridContainerRef.current.offsetHeight;    if (containerHeight === 0) return;    const itemHeight = 88;    const windowWidth = window.innerWidth;    let cols = 1;    if (windowWidth >= 1024) { // lg      cols = 3;    } else if (windowWidth >= 640) { // sm      cols = 2;    }    if (itemHeight > 0) {      const rowsThatFit = Math.floor(containerHeight / itemHeight);      const rowsToRender = rowsThatFit + 1;      setItemsToRender(rowsToRender * cols);    }  }, []);  useLayoutEffect(() => {    const timer = setTimeout(() => {      calculateGridItems();    }, 100);    window.addEventListener('resize', calculateGridItems);    return () => {      clearTimeout(timer);      window.removeEventListener('resize', calculateGridItems);    };  }, [calculateGridItems, analyticsData?.paymentMethodStats.methods]);  const renderPaymentMethodGrid = () => {    const methods = analyticsData?.paymentMethodStats.methods || [];    const totalMethods = methods.length;    const windowWidth = typeof window !== 'undefined' ? window.innerWidth : 1024;    let cols = 1;    if (windowWidth >= 1024) { // lg      cols = 3;    } else if (windowWidth >= 640) { // sm      cols = 2;    }    const numToRender = Math.max(itemsToRender, totalMethods);    const displayCount = Math.ceil(numToRender / cols) * cols;    const items = Array.from({ length: displayCount }, (_, i) => methods[i] || null);    return (      <div ref={gridContainerRef} className="relative lg:col-span-2 border-t lg:border-t-0 lg:border-l border-gray-200 dark:border-gray-800">        <div className="absolute inset-0 overflow-y-auto overflow-x-hidden">          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 -m-px">            {items.map((method, index) => (              <div                key={method ? method.id : `placeholder-${index}`}                className={cn(                  "p-4 flex flex-col items-center justify-center text-center border border-gray-200 dark:border-gray-800 h-[88px]",                  { "cursor-pointer transition-transform hover:scale-105": !!method },                )}                onClick={() => method && navigate(`/payment-methods/${method.id}`)}              >                {method ? (                  <>                    <span className="font-medium text-gray-700 dark:text-gray-300 truncate">{method.name}</span>                    <span className={cn("font-semibold text-lg", method.balance >= 0 ? 'text-green' : 'text-red')}>                      €{method.balance >= 0 ? '+' : ''}{method.balance.toFixed(2)}                    </span>                  </>                ) : (                  <MinusIcon className="h-6 w-6 text-gray-400" />                )}              </div>            ))}          </div>        </div>      </div>    );  };  return (    <div>      <Header title="Analytics" variant="tabs" tabs={renderTabs()} />      <PageWrapper>        <div className="py-6 space-y-6">          {activeTab === 'general' && (            <>              {paymentMethodsEnabled && (                <div className="pt-2">                  <div className="rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm overflow-hidden">                    <div className="grid grid-cols-1 lg:grid-cols-3">                      <div className="relative lg:col-span-1 overflow-hidden">                        <div                          style={{'--glassRotation': '-16deg', '--gradientRotation': '14deg'} as React.CSSProperties}                          className="absolute inset-0"                        >                          <div className="relative grid h-full w-full place-items-center">                            <div className="h-1/2 w-1/2 rotate-[var(--gradientRotation)] rounded-[3vw] bg-[image:var(--primary-gradient)] mix-blend-hard-light"></div>                            <div className="absolute inset-0 scale-[2] rotate-[var(--glassRotation)] bg-[image:var(--frost-gradient)] bg-[size:30px] mix-blend-color-dodge backdrop-blur-[15px]"></div>                          </div>                        </div>                        <div className="relative p-6 flex flex-col justify-center items-center bg-transparent h-full aspect-square" style={{minHeight: '220px'}}>                          <div className="text-center text-inverted">                            <p className="text-lg">Net Worth</p>                            <p className="text-2xl sm:text-3xl md:text-4xl font-bold mt-1">                              €{analyticsData?.paymentMethodStats.totalCapacity.toFixed(2) || '0.00'}                            </p>                          </div>                        </div>                      </div>                      {renderPaymentMethodGrid()}                    </div>                  </div>                </div>              )}              <div className="my-6 border-b border-gray-200 dark:border-gray-800"></div>              <div className="flex items-center justify-end">                <div className="w-48"><Select value={selectedYear}                                              onChange={(e: React.ChangeEvent<HTMLSelectElement>) => setSelectedYear(e.target.value)}                                              options={(availableYears || []).map(y => ({value: y, label: y}))}/></div>              </div>              <Card>                <div className="p-6">                  <CardHeader title="Monthly Spending" tooltipText={`Total spending for each month in ${selectedYear}.`}/>                  {isLoading ? <div className="flex justify-center items-center h-[300px] w-full"><Spinner/></div> :                    <ReactECharts ref={monthlyChartRef}                                  option={monthlyChartOption}                                  theme={theme}                                  style={{height: '300px'}}                                  notMerge={true}/>}                </div>              </Card>              <Card>                <div className="p-4 overflow-x-auto">                  <table className="w-full text-sm text-center">                    <thead>                    <tr>                      <th className="p-2 text-left text-gray-500 font-medium w-24"></th>                      {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map(m => (                        <th key={m} className="p-2 font-medium text-gray-700 dark:text-gray-300 min-w-[60px]">{m}</th>))}                    </tr>                    </thead>                    <tbody className="divide-y dark:divide-gray-800">                    <tr>                      <td className="p-2 text-left font-medium text-gray-600 dark:text-gray-400">                        <div className="flex items-center gap-1">vs                                                                 Prev <Tooltip content="Compares spending to the previous month."><InformationCircleIcon                            className="h-4 w-4 text-gray-400"/></Tooltip></div>                      </td>                      {analyticsData?.monthlySpending.map((month, i) => (                        <td key={i} className="p-2"><TrendIndicator current={month.total} previous={month.prevMonthTotal}/>                        </td>))}                    </tr>                    <tr>                      <td className="p-2 text-left font-medium text-gray-600 dark:text-gray-400">                        <div className="flex items-center gap-1">vs                                                                 Year <Tooltip content="Compares spending to the same month in the previous year."><InformationCircleIcon                            className="h-4 w-4 text-gray-400"/></Tooltip></div>                      </td>                      {analyticsData?.monthlySpending.map((month, i) => (                        <td key={i} className="p-2"><TrendIndicator current={month.total} previous={month.prevYearMonthTotal}/>                        </td>))}                    </tr>                    </tbody>                  </table>                </div>              </Card>              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">                <Card>                  <div className="p-6">                    <CardHeader title="Spending by Store"                                tooltipText={`Breakdown of total spending per store for ${selectedYear}.`}/>                    {isLoading ? <div className="flex justify-center items-center h-[300px] w-full"><Spinner/></div> :                      <ReactECharts ref={storeChartRef}                                    option={storeChartOption}                                    theme={theme}                                    style={{height: '300px'}}                                    notMerge={true}/>}                  </div>                </Card>                <Card>                  <div className="p-6">                    <CardHeader title="Receipt Averages"                                tooltipText={`Average values calculated from all receipts in ${selectedYear}.`}/>                    <div className="space-y-6 mt-2">                      <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl">                        <div className="flex items-center gap-3">                          <div className="p-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg">                            <CurrencyEuroIcon className="h-6 w-6"/></div>                          <span className="font-medium text-gray-600 dark:text-gray-300">Avg. Receipt Total</span></div>                        <span className="text-xl font-bold">€{analyticsData?.averages.avgPerReceipt.toFixed(2) || '0.00'}</span></div>                      <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl">                        <div className="flex items-center gap-3">                          <div className="p-2 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-lg">                            <ShoppingBagIcon className="h-6 w-6"/></div>                          <span className="font-medium text-gray-600 dark:text-gray-300">Avg. Items / Receipt</span></div>                        <span className="text-xl font-bold">{analyticsData?.averages.avgItemsPerReceipt.toFixed(1) || '0.0'}</span></div>                      <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl">                        <div className="flex items-center gap-3">                          <div className="p-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-lg">                            <CalculatorIcon className="h-6 w-6"/></div>                          <span className="font-medium text-gray-600 dark:text-gray-300">Avg. Price / Item</span></div>                        <span className="text-xl font-bold">€{analyticsData?.averages.avgPricePerItem.toFixed(2) || '0.00'}</span></div>                    </div>                  </div>                </Card>              </div>            </>          )}          {activeTab === 'products' && (            <div className="col-span-1 lg:col-span-2 pt-6">              {analyticsData?.hasItemlessReceipts && (                <div className="mb-6">                  <InfoCard                    variant="warning"                    title="Data Accuracy"                    message="The following analytics may not be entirely accurate as there are one or more toal-only receipts."                  />                </div>              )}              <TopProducts/>            </div>          )}          {activeTab === 'debt' && debtEnabled && (            <div className="pt-2">              <div className="flex items-center gap-2 mb-4">                <h2 className="text-xl font-semibold">Debt Analytics</h2>              </div>              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">                <Card className="p-4 text-center bg-green-50 dark:bg-green-900/20">                  <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Total Owed to You</p>                  <p className="text-2xl font-bold text-green">€{analyticsData?.debtStats.totalOwedToMe.toFixed(2) || '0.00'}</p>                </Card>                <Card className="p-4 text-center bg-red-50 dark:bg-red-900/20">                  <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Total You Owe</p>                  <p className="text-2xl font-bold text-red">€{analyticsData?.debtStats.totalOwedByMe.toFixed(2) || '0.00'}</p>                </Card>                <Card className={cn("p-4 text-center", ((analyticsData?.debtStats.totalOwedToMe || 0) - (analyticsData?.debtStats.totalOwedByMe || 0)) >= 0 ? "bg-blue-50 dark:bg-blue-900/20" : "bg-purple-50 dark:bg-purple-900/20")}>                  <p className="text-sm font-medium text-gray-500 dark:text-gray-400">Overall Debt Balance</p>                  <p className={cn("text-2xl font-bold", ((analyticsData?.debtStats.totalOwedToMe || 0) - (analyticsData?.debtStats.totalOwedByMe || 0)) >= 0 ? "text-blue-600 dark:text-blue-400" : "text-purple-600 dark:text-purple-400")}>                    €{((analyticsData?.debtStats.totalOwedToMe || 0) - (analyticsData?.debtStats.totalOwedByMe || 0)).toFixed(2)}                  </p>                </Card>              </div>              <Card>                <div className="p-6">                  <CardHeader title="Net Balance per Entity"                              tooltipText="Shows the net financial position with each entity. Positive values (green) mean they owe you, negative (red) mean you owe them."/>                  {isLoading ? <div className="flex justify-center items-center h-[400px] w-full"><Spinner/></div> :                    <ReactECharts ref={debtBarChartRef}                                  option={debtBarChartOption}                                  theme={theme}                                  style={{height: '400px'}}                                  notMerge={true}/>}                </div>              </Card>            </div>          )}        </div>      </PageWrapper>    </div>  );};export default AnalyticsPage;